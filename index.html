<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ระบบรวบรวมระบบจัดการงานโรงเรียนแบบออนไลน์</title>
<link rel="icon" href="https://nonthaphathr.github.io/uploadimg/logoschool.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root {
  --bg: #0a0a0a;
  --bg2: #111111;
  --bg3: #181818;
  --orange: #f97316;
  --orange2: #fb923c;
  --orange3: #fdba74;
  --gold: #f59e0b;
  --text: #f5f5f5;
  --text2: #a3a3a3;
  --border: rgba(249,115,22,0.2);
  --border2: rgba(255,255,255,0.06);
  --glow: 0 0 30px rgba(249,115,22,0.3);
  --glow2: 0 0 60px rgba(249,115,22,0.15);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Kanit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ─── Grid background ─── */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image:
    linear-gradient(rgba(249,115,22,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(249,115,22,0.04) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events:none;
  z-index:0;
}

/* ─── Ambient orbs ─── */
.orb {
  position:fixed;
  border-radius:50%;
  filter:blur(80px);
  pointer-events:none;
  z-index:0;
}
.orb1 { width:400px;height:400px;background:rgba(249,115,22,0.12);top:-100px;right:-100px; }
.orb2 { width:300px;height:300px;background:rgba(251,146,60,0.08);bottom:100px;left:-80px; }
.orb3 { width:200px;height:200px;background:rgba(245,158,11,0.06);top:50%;left:50%;transform:translate(-50%,-50%); }

/* ─── Header ─── */
header {
  position:sticky;
  top:0;
  z-index:100;
  background: rgba(10,10,10,0.85);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
}

.header-inner {
  max-width:1200px;
  margin:0 auto;
  padding:0 1.5rem;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
}

.logo-wrap {
  display:flex;
  align-items:center;
  gap:1rem;
  flex-shrink:0;
}

.logo-img {
  width:44px;
  height:44px;
  border-radius:50%;
  border:2px solid var(--orange);
  box-shadow: 0 0 16px rgba(249,115,22,0.4);
  object-fit:cover;
  animation: logoPulse 3s ease-in-out infinite;
}

@keyframes logoPulse {
  0%,100% { box-shadow: 0 0 16px rgba(249,115,22,0.4); }
  50% { box-shadow: 0 0 30px rgba(249,115,22,0.7), 0 0 60px rgba(249,115,22,0.3); }
}

.logo-text h1 {
  font-size:0.9rem;
  font-weight:700;
  color:var(--text);
  line-height:1.2;
}

.logo-text p {
  font-size:0.65rem;
  color:var(--orange);
  font-weight:500;
  letter-spacing:0.05em;
}

.header-actions {
  display:flex;
  align-items:center;
  gap:0.75rem;
}

/* ─── Search ─── */
.search-wrap {
  position:relative;
  flex:1;
  max-width:340px;
}

.search-wrap i {
  position:absolute;
  left:1rem;
  top:50%;
  transform:translateY(-50%);
  color:var(--text2);
  font-size:0.85rem;
  pointer-events:none;
  transition:color 0.3s;
}

.search-wrap:focus-within i { color:var(--orange); }

.search-input {
  width:100%;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border2);
  border-radius:12px;
  padding:0.6rem 1rem 0.6rem 2.5rem;
  color:var(--text);
  font-family:'Kanit',sans-serif;
  font-size:0.85rem;
  outline:none;
  transition:all 0.3s;
}

.search-input::placeholder { color:var(--text2); }
.search-input:focus {
  border-color: var(--orange);
  background: rgba(249,115,22,0.06);
  box-shadow: 0 0 20px rgba(249,115,22,0.15);
}

/* ─── Buttons ─── */
.btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  padding:0.6rem 1.25rem;
  border-radius:10px;
  font-family:'Kanit',sans-serif;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  border:none;
  transition:all 0.3s;
  position:relative;
  overflow:hidden;
  white-space:nowrap;
}

.btn::before {
  content:'';
  position:absolute;
  top:0;left:-100%;
  width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);
  transition:left 0.5s;
}
.btn:hover::before { left:100%; }

.btn-orange {
  background:linear-gradient(135deg,var(--orange),var(--gold));
  color:#000;
  box-shadow: 0 4px 20px rgba(249,115,22,0.35);
}
.btn-orange:hover {
  transform:translateY(-2px);
  box-shadow: 0 8px 30px rgba(249,115,22,0.5);
}
.btn-orange:active { transform:translateY(0); }

.btn-ghost {
  background: rgba(255,255,255,0.06);
  color:var(--text2);
  border:1px solid var(--border2);
}
.btn-ghost:hover {
  background: rgba(249,115,22,0.12);
  color:var(--orange);
  border-color:var(--border);
}

.btn-icon {
  width:40px; height:40px;
  padding:0;
  border-radius:10px;
}

/* ─── Hero ─── */
.hero {
  position:relative;
  z-index:1;
  text-align:center;
  padding:4rem 1.5rem 2rem;
  max-width:1200px;
  margin:0 auto;
}

.hero-badge {
  display:inline-flex;
  align-items:center;
  gap:0.5rem;
  background:rgba(249,115,22,0.1);
  border:1px solid var(--border);
  border-radius:99px;
  padding:0.35rem 1rem;
  font-size:0.75rem;
  color:var(--orange2);
  font-weight:600;
  letter-spacing:0.05em;
  margin-bottom:1.5rem;
  animation: fadeSlideUp 0.6s ease both;
}

.hero h2 {
  font-size:clamp(1.6rem, 5vw, 3rem);
  font-weight:900;
  line-height:1.1;
  margin-bottom:0.75rem;
  animation: fadeSlideUp 0.6s 0.1s ease both;
}

.hero h2 span {
  background:linear-gradient(135deg,var(--orange),var(--gold));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.hero p {
  color:var(--text2);
  font-size:0.95rem;
  max-width:500px;
  margin:0 auto 1.5rem;
  animation: fadeSlideUp 0.6s 0.2s ease both;
  line-height:1.7;
}

.stats-row {
  display:flex;
  justify-content:center;
  gap:2.5rem;
  flex-wrap:wrap;
  animation: fadeSlideUp 0.6s 0.3s ease both;
}

.stat-item {
  text-align:center;
}

.stat-num {
  font-size:1.75rem;
  font-weight:900;
  background:linear-gradient(135deg,var(--orange),var(--gold));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.stat-label {
  font-size:0.7rem;
  color:var(--text2);
  font-weight:500;
  letter-spacing:0.05em;
}

@keyframes fadeSlideUp {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}

/* ─── Filter ─── */
.filter-bar {
  position:sticky;
  top:70px;
  z-index:90;
  background: rgba(10,10,10,0.9);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border2);
  padding:0.75rem 1.5rem;
}

.filter-inner {
  max-width:1200px;
  margin:0 auto;
  display:flex;
  gap:0.5rem;
  overflow-x:auto;
  scrollbar-width:none;
}
.filter-inner::-webkit-scrollbar { display:none; }

.filter-chip {
  flex-shrink:0;
  padding:0.45rem 1rem;
  border-radius:99px;
  font-family:'Kanit',sans-serif;
  font-size:0.8rem;
  font-weight:600;
  cursor:pointer;
  border:1px solid var(--border2);
  background:transparent;
  color:var(--text2);
  transition:all 0.3s;
  white-space:nowrap;
}

.filter-chip:hover {
  color:var(--orange);
  border-color:var(--border);
}

.filter-chip.active {
  background:linear-gradient(135deg,var(--orange),var(--gold));
  color:#000;
  border-color:transparent;
  box-shadow: 0 4px 15px rgba(249,115,22,0.35);
  transform:scale(1.05);
}

/* ─── Grid ─── */
.grid-wrap {
  position:relative;
  z-index:1;
  max-width:1200px;
  margin:0 auto;
  padding:1.5rem;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap:1.5rem;
}

/* ─── Card ─── */
.card {
  background: var(--bg2);
  border:1px solid var(--border2);
  border-radius:20px;
  overflow:hidden;
  transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
  cursor:pointer;
  position:relative;
  animation: cardIn 0.5s ease both;
}

.card:hover {
  border-color:var(--border);
  transform:translateY(-6px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5), var(--glow2);
}

@keyframes cardIn {
  from { opacity:0; transform:translateY(30px) scale(0.97); }
  to { opacity:1; transform:translateY(0) scale(1); }
}

/* card cover */
.card-cover {
  position:relative;
  height:200px;
  overflow:hidden;
  background:#0d0d0d;
}

.card-cover-bg {
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition:transform 0.6s ease;
}

.card:hover .card-cover-bg { transform:scale(1.05); }

/* Overlay text on cover */
.card-cover-overlay {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(180deg,rgba(0,0,0,0.3) 0%,rgba(0,0,0,0.7) 100%);
  padding:1rem;
}

.card-cover-title {
  font-size:clamp(0.9rem,2.5vw,1.25rem);
  font-weight:700;
  color:#fff;
  text-align:center;
  text-shadow: 0 2px 8px rgba(0,0,0,0.8), 0 4px 20px rgba(0,0,0,0.6);
  line-height:1.3;
  word-break:break-word;
}

/* card body */
.card-body {
  padding:1.25rem;
}

.card-meta {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:0.75rem;
}

.card-cat {
  font-size:0.7rem;
  font-weight:700;
  color:var(--orange);
  background:rgba(249,115,22,0.1);
  border:1px solid rgba(249,115,22,0.2);
  border-radius:99px;
  padding:0.2rem 0.75rem;
  letter-spacing:0.05em;
  text-transform:uppercase;
}

.card-date {
  font-size:0.7rem;
  color:var(--text2);
  display:flex;
  align-items:center;
  gap:0.3rem;
}

.card-name {
  font-size:1rem;
  font-weight:700;
  color:var(--text);
  margin-bottom:0.5rem;
  line-height:1.4;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.card-desc {
  font-size:0.8rem;
  color:var(--text2);
  line-height:1.6;
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
  margin-bottom:1rem;
}

.card-footer {
  display:flex;
  align-items:center;
  gap:0.5rem;
  border-top:1px solid var(--border2);
  padding-top:1rem;
}

.card-link {
  flex:1;
  display:flex;
  align-items:center;
  gap:0.4rem;
  font-size:0.8rem;
  font-weight:600;
  color:var(--orange);
  text-decoration:none;
  transition:gap 0.2s;
}
.card-link:hover { gap:0.7rem; }
.card-link i { font-size:0.75rem; }

.card-actions {
  display:flex;
  gap:0.4rem;
}

.icon-btn {
  width:34px;height:34px;
  border-radius:8px;
  border:1px solid var(--border2);
  background:transparent;
  color:var(--text2);
  font-size:0.75rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s;
}

.icon-btn:hover {
  background:rgba(249,115,22,0.12);
  color:var(--orange);
  border-color:var(--border);
  transform:scale(1.1);
}

.icon-btn.delete:hover {
  background:rgba(239,68,68,0.12);
  color:#ef4444;
  border-color:rgba(239,68,68,0.3);
}

/* ─── Skeleton ─── */
.skeleton-card {
  background:var(--bg2);
  border:1px solid var(--border2);
  border-radius:20px;
  overflow:hidden;
  animation:pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%,100% { opacity:0.6; }
  50% { opacity:1; }
}

.skel { background:rgba(255,255,255,0.06); border-radius:8px; }
.skel-cover { height:200px; }
.skel-body { padding:1.25rem; }
.skel-line { height:12px; margin-bottom:10px; }
.skel-sm { width:40%; }
.skel-md { width:70%; }
.skel-lg { width:100%; }

/* ─── Empty state ─── */
.empty {
  grid-column:1/-1;
  text-align:center;
  padding:5rem 1rem;
  animation:fadeSlideUp 0.5s ease;
}
.empty-icon {
  width:80px;height:80px;
  border-radius:20px;
  background:rgba(249,115,22,0.08);
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 1.5rem;
  font-size:2rem;
  color:var(--orange);
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%,100% { transform:translateY(0); }
  50% { transform:translateY(-8px); }
}

.empty h3 { font-size:1.1rem; font-weight:700; margin-bottom:0.5rem; }
.empty p { font-size:0.85rem; color:var(--text2); }

/* ─── Modal ─── */
.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(8px);
  z-index:200;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding:0;
  animation:fadeIn 0.3s ease;
}

@media (min-width:640px) {
  .modal-backdrop { align-items:center; padding:1rem; }
}

@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.modal-box {
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:20px 20px 0 0;
  width:100%;
  max-width:520px;
  max-height:90vh;
  overflow-y:auto;
  scrollbar-width:none;
  padding:2rem;
  animation:slideUp 0.4s cubic-bezier(0.16,1,0.3,1);
}

@media (min-width:640px) {
  .modal-box { border-radius:20px; }
}

@keyframes slideUp {
  from{transform:translateY(40px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

.modal-box::-webkit-scrollbar { display:none; }

.modal-header {
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  margin-bottom:1.75rem;
}

.modal-title h3 { font-size:1.3rem; font-weight:800; }
.modal-title p { font-size:0.8rem; color:var(--text2); margin-top:0.2rem; }

.close-btn {
  width:36px;height:36px;
  border-radius:10px;
  border:1px solid var(--border2);
  background:transparent;
  color:var(--text2);
  font-size:1.1rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s;
  flex-shrink:0;
}
.close-btn:hover { background:rgba(255,255,255,0.08); color:var(--text); }

.form-group { margin-bottom:1.25rem; }

.form-label {
  display:flex;
  align-items:center;
  gap:0.4rem;
  font-size:0.8rem;
  font-weight:600;
  color:var(--text2);
  margin-bottom:0.5rem;
  letter-spacing:0.03em;
  text-transform:uppercase;
}
.form-label i { color:var(--orange); font-size:0.75rem; }

.form-input, .form-textarea, .form-select {
  width:100%;
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border2);
  border-radius:12px;
  padding:0.85rem 1rem;
  color:var(--text);
  font-family:'Kanit',sans-serif;
  font-size:0.9rem;
  outline:none;
  transition:all 0.3s;
}

.form-input::placeholder, .form-textarea::placeholder { color:rgba(163,163,163,0.5); }
.form-input:focus, .form-textarea:focus, .form-select:focus {
  border-color:var(--orange);
  background:rgba(249,115,22,0.06);
  box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
}

.form-textarea { resize:none; min-height:100px; }

.form-select {
  cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23f97316' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 1rem center;
  padding-right:2.5rem;
}

.form-select option { background:#181818; }

.form-hint {
  font-size:0.72rem;
  color:var(--text2);
  margin-top:0.4rem;
  display:flex;
  align-items:center;
  gap:0.3rem;
}

.cover-preview {
  margin-top:0.75rem;
  border-radius:12px;
  overflow:hidden;
  border:1px solid var(--border2);
  position:relative;
  height:120px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.cover-preview-bg {
  position:absolute;
  inset:0;
  object-fit:cover;
  width:100%;
  height:100%;
}

.cover-preview-overlay {
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.7));
  display:flex;
  align-items:center;
  justify-content:center;
  padding:1rem;
}

.cover-preview-text {
  color:#fff;
  font-weight:700;
  font-size:0.9rem;
  text-align:center;
  text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  z-index:1;
}

.submit-btn {
  width:100%;
  padding:1rem;
  border-radius:14px;
  background:linear-gradient(135deg,var(--orange),var(--gold));
  border:none;
  color:#000;
  font-family:'Kanit',sans-serif;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  margin-top:0.5rem;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  transition:all 0.3s;
  position:relative;
  overflow:hidden;
}

.submit-btn::before {
  content:'';
  position:absolute;
  top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);
  transition:left 0.5s;
}
.submit-btn:hover::before { left:100%; }
.submit-btn:hover { box-shadow:0 8px 30px rgba(249,115,22,0.5); transform:translateY(-1px); }
.submit-btn:active { transform:translateY(0); }
.submit-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

/* ─── Orange accent line ─── */
.section-line {
  display:flex;
  align-items:center;
  gap:1rem;
  max-width:1200px;
  margin:0 auto;
  padding:0 1.5rem 1.25rem;
}

.section-line-bar {
  height:2px;
  flex:1;
  background:linear-gradient(90deg,rgba(249,115,22,0.4),transparent);
}

.section-line-text {
  font-size:0.75rem;
  color:var(--text2);
  font-weight:600;
  letter-spacing:0.1em;
  text-transform:uppercase;
  white-space:nowrap;
}

/* ─── Toast SweetAlert override ─── */
.swal2-popup { font-family:'Kanit',sans-serif !important; }

/* ─── Scrollbar ─── */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:99px; }

/* ─── Category colors ─── */
.cat-academic { color:#60a5fa; background:rgba(96,165,250,0.1); border-color:rgba(96,165,250,0.2); }
.cat-admin { color:#a78bfa; background:rgba(167,139,250,0.1); border-color:rgba(167,139,250,0.2); }
.cat-finance { color:#34d399; background:rgba(52,211,153,0.1); border-color:rgba(52,211,153,0.2); }
.cat-student { color:#f472b6; background:rgba(244,114,182,0.1); border-color:rgba(244,114,182,0.2); }
.cat-other { color:var(--orange); background:rgba(249,115,22,0.1); border-color:rgba(249,115,22,0.2); }

/* ─── Responsive ─── */
@media (max-width:640px) {
  .hero { padding:2.5rem 1rem 1.5rem; }
  .logo-text h1 { font-size:0.75rem; }
  .logo-text p { display:none; }
  .search-wrap { max-width:180px; }
  .grid-wrap { grid-template-columns:1fr; gap:1rem; }
}

/* Detail Modal */
.detail-body { }

.detail-cat {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  font-size:0.75rem;
  font-weight:700;
  border-radius:99px;
  padding:0.3rem 0.85rem;
  margin-bottom:1rem;
  letter-spacing:0.05em;
  text-transform:uppercase;
}

.detail-desc {
  font-size:0.9rem;
  color:var(--text2);
  line-height:1.8;
  margin-bottom:1.5rem;
  white-space:pre-wrap;
}

.detail-meta {
  display:flex;
  align-items:center;
  gap:0.5rem;
  font-size:0.75rem;
  color:var(--text2);
  margin-bottom:1rem;
}

.detail-link {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  width:100%;
  padding:1rem;
  border-radius:14px;
  background:linear-gradient(135deg,var(--orange),var(--gold));
  color:#000;
  font-family:'Kanit',sans-serif;
  font-size:1rem;
  font-weight:700;
  text-decoration:none;
  transition:all 0.3s;
  box-shadow:0 4px 20px rgba(249,115,22,0.35);
}
.detail-link:hover { box-shadow:0 8px 30px rgba(249,115,22,0.5); transform:translateY(-2px); }

/* Loading spinner */
.loading-wrap {
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:300;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:1.5rem;
  animation:fadeOut 0.5s 1.5s ease forwards;
}

@keyframes fadeOut {
  to { opacity:0; pointer-events:none; }
}

.loader-ring {
  width:60px;height:60px;
  border:3px solid rgba(249,115,22,0.2);
  border-top-color:var(--orange);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

.loader-text {
  font-size:0.85rem;
  color:var(--text2);
  letter-spacing:0.1em;
  text-transform:uppercase;
}

/* Ticker dev */
.dev-tag {
  display:inline-flex;
  align-items:center;
  gap:0.4rem;
  font-size:0.7rem;
  color:var(--text2);
  margin-top:1.5rem;
  opacity:0.6;
}
.dev-tag img {
  width:20px;height:20px;
  border-radius:50%;
  border:1px solid var(--border);
}

/* Notification badge */
.notif {
  position:absolute;
  top:-4px;right:-4px;
  width:16px;height:16px;
  border-radius:50%;
  background:var(--orange);
  font-size:0.6rem;
  font-weight:700;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  border:2px solid var(--bg);
}

/* ─── QR Modal ─── */
.qr-modal-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 24px 24px 0 0;
  width: 100%;
  max-width: 400px;
  padding: 2rem;
  animation: slideUp 0.4s cubic-bezier(0.16,1,0.3,1);
  position: relative;
  overflow: hidden;
}
@media (min-width:640px) { .qr-modal-box { border-radius:24px; } }

.qr-modal-box::before {
  content:'';
  position:absolute;
  top:-60px; right:-60px;
  width:180px; height:180px;
  background: radial-gradient(circle, rgba(249,115,22,0.15) 0%, transparent 70%);
  pointer-events:none;
}

.qr-canvas-wrap {
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 1.5rem 0;
}

.qr-canvas-frame {
  position:relative;
  padding: 16px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 0 40px rgba(249,115,22,0.25), 0 0 0 1px rgba(249,115,22,0.3);
}

.qr-canvas-frame canvas {
  display: block;
  border-radius: 8px;
}

/* Corner decorations */
.qr-corner {
  position:absolute;
  width:20px; height:20px;
  border-color: var(--orange);
  border-style: solid;
}
.qr-corner-tl { top:-2px; left:-2px; border-width:3px 0 0 3px; border-radius:6px 0 0 0; }
.qr-corner-tr { top:-2px; right:-2px; border-width:3px 3px 0 0; border-radius:0 6px 0 0; }
.qr-corner-bl { bottom:-2px; left:-2px; border-width:0 0 3px 3px; border-radius:0 0 0 6px; }
.qr-corner-br { bottom:-2px; right:-2px; border-width:0 3px 3px 0; border-radius:0 0 6px 0; }

.qr-title-chip {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.4rem;
  background:rgba(249,115,22,0.1);
  border:1px solid var(--border);
  border-radius:99px;
  padding:0.35rem 1rem;
  font-size:0.75rem;
  color:var(--orange);
  font-weight:700;
  letter-spacing:0.05em;
  margin-bottom:0.5rem;
}

.qr-system-name {
  font-size:1rem;
  font-weight:700;
  text-align:center;
  color:var(--text);
  margin-bottom:0.25rem;
  padding:0 1rem;
  line-height:1.4;
}

.qr-url-text {
  font-size:0.72rem;
  color:var(--text2);
  text-align:center;
  word-break:break-all;
  padding:0 0.5rem;
  line-height:1.5;
}

.qr-actions {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:0.75rem;
  margin-top:1.5rem;
}

.qr-btn {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.4rem;
  padding:0.85rem;
  border-radius:14px;
  font-family:'Kanit',sans-serif;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  border:none;
  transition:all 0.3s;
}

.qr-btn-primary {
  background:linear-gradient(135deg,var(--orange),var(--gold));
  color:#000;
  box-shadow:0 4px 15px rgba(249,115,22,0.35);
}
.qr-btn-primary:hover { box-shadow:0 6px 20px rgba(249,115,22,0.5); transform:translateY(-1px); }

.qr-btn-ghost {
  background:rgba(255,255,255,0.06);
  color:var(--text);
  border:1px solid var(--border2);
}
.qr-btn-ghost:hover { background:rgba(249,115,22,0.12); color:var(--orange); border-color:var(--border); }

/* ─── Copy toast ─── */
@keyframes copyPop {
  0% { transform:scale(0.8) translateY(10px); opacity:0; }
  60% { transform:scale(1.05) translateY(-2px); opacity:1; }
  100% { transform:scale(1) translateY(0); opacity:1; }
}

.copy-toast {
  position:fixed;
  bottom:2rem;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(135deg,var(--orange),var(--gold));
  color:#000;
  font-weight:700;
  font-size:0.85rem;
  padding:0.75rem 1.5rem;
  border-radius:99px;
  box-shadow:0 8px 30px rgba(249,115,22,0.4);
  z-index:9999;
  display:flex;
  align-items:center;
  gap:0.5rem;
  animation:copyPop 0.4s ease;
  pointer-events:none;
  white-space:nowrap;
}

/* ─── Detail action buttons ─── */
.detail-action-row {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:0.6rem;
  margin-bottom:0.75rem;
}

.detail-action-btn {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.4rem;
  padding:0.75rem;
  border-radius:12px;
  font-family:'Kanit',sans-serif;
  font-size:0.8rem;
  font-weight:600;
  cursor:pointer;
  border:1px solid var(--border2);
  background:rgba(255,255,255,0.04);
  color:var(--text2);
  transition:all 0.3s;
}
.detail-action-btn:hover {
  background:rgba(249,115,22,0.1);
  color:var(--orange);
  border-color:var(--border);
  transform:translateY(-1px);
}
.detail-action-btn:active { transform:translateY(0); }
</style>
</head>
<body>

<!-- Loading screen -->
<div class="loading-wrap" id="loader">
  <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" style="width:60px;height:60px;border-radius:50%;border:2px solid var(--orange);box-shadow:0 0 20px rgba(249,115,22,0.5);" onerror="this.style.display='none'">
  <div class="loader-ring"></div>
  <div class="loader-text">กำลังโหลดระบบ...</div>
</div>

<!-- Ambient -->
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<!-- Header -->
<header>
  <div class="header-inner">
    <div class="logo-wrap">
      <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" class="logo-img" onerror="this.src='https://via.placeholder.com/44/f97316/000?text=S'" alt="Logo">
      <div class="logo-text">
        <h1>ระบบจัดการงานโรงเรียน</h1>
        <p>SCHOOL MANAGEMENT SYSTEM</p>
      </div>
    </div>

    <div class="search-wrap">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input class="search-input" id="searchInput" type="text" placeholder="ค้นหาระบบ...">
    </div>

    <div class="header-actions">
      <button class="btn btn-orange" id="openAddBtn">
        <i class="fa-solid fa-plus"></i>
        <span class="btn-label">เพิ่มระบบ</span>
      </button>
    </div>
  </div>
</header>

<!-- Hero -->
<section class="hero">
  <div class="hero-badge">
    <i class="fa-solid fa-circle" style="font-size:0.5rem;color:var(--orange);animation:logoPulse 1.5s ease-in-out infinite"></i>
    ONLINE SYSTEM PORTAL
  </div>
  <h2>รวมระบบจัดการงานโรงเรียน<br><span>แบบออนไลน์</span></h2>
  <p>รวบรวมระบบดิจิทัลสำหรับการบริหารจัดการโรงเรียนในยุคดิจิทัล</p>
  <div class="stats-row" id="statsRow">
    <div class="stat-item">
      <div class="stat-num" id="statCount">0</div>
      <div class="stat-label">ระบบทั้งหมด</div>
    </div>
    <div class="stat-item">
      <div class="stat-num" id="statCat">0</div>
      <div class="stat-label">หมวดหมู่</div>
    </div>
    <div class="stat-item">
      <div class="stat-num" id="statDev">1</div>
      <div class="stat-label">ผู้พัฒนา</div>
    </div>
  </div>
  <div class="dev-tag">
    <img src="https://nonthaphathr.github.io/uploadimg/logobunthuk.png" onerror="this.style.display='none'">
    พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง
  </div>
</section>

<!-- Filter -->
<div class="filter-bar">
  <div class="filter-inner" id="filterBar">
    <button class="filter-chip active" data-cat="ทั้งหมด">ทั้งหมด</button>
    <button class="filter-chip" data-cat="กลุ่มบริหารงานวิชาการ">กลุ่มบริหารงานวิชาการ</button>
    <button class="filter-chip" data-cat="กลุ่มบริหารงานงบประมาณ">กลุ่มบริหารงานงบประมาณ</button>
    <button class="filter-chip" data-cat="กลุ่มบริหารงานทั่วไป">กลุ่มบริหารงานทั่วไป</button>
    <button class="filter-chip" data-cat="กลุ่มบริหารงานบุคคล">กลุ่มบริหารงานบุคคล</button>
    <button class="filter-chip" data-cat="อื่นๆ">อื่นๆ</button>
  </div>
</div>

<!-- Section line -->
<div class="section-line">
  <div class="section-line-bar"></div>
  <div class="section-line-text" id="resultCount">โหลดข้อมูล...</div>
  <div class="section-line-bar" style="background:linear-gradient(270deg,rgba(249,115,22,0.4),transparent)"></div>
</div>

<!-- Grid -->
<div class="grid-wrap" id="cardGrid"></div>

<!-- ═══════════════════ ADD / EDIT MODAL ═══════════════════ -->
<div class="modal-backdrop" id="formModal" style="display:none">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <h3 id="modalTitle">เพิ่มระบบใหม่</h3>
        <p>กรอกข้อมูลระบบให้ครบถ้วน</p>
      </div>
      <button class="close-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <form id="systemForm" onsubmit="handleSubmit(event)">
      <input type="hidden" id="editId">

      <div class="form-group">
        <label class="form-label"><i class="fa-solid fa-server"></i> ชื่อระบบ</label>
        <input class="form-input" id="fTitle" type="text" placeholder="เช่น ระบบตรวจสอบการเข้าเรียน" required>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fa-solid fa-id-card"></i> ชื่อที่แสดงบน Card Cover</label>
        <input class="form-input" id="fCoverTitle" type="text" placeholder="ชื่อสั้นสำหรับ Cover (ไม่เกิน 40 ตัวอักษร)">
        <div class="form-hint"><i class="fa-solid fa-circle-info"></i> ค่าเริ่มต้นตรงกับชื่อระบบ</div>
        <div class="cover-preview" id="coverPreview">
          <img src="https://nonthaphathr.github.io/uploadimg/cardcover.png" class="cover-preview-bg" onerror="this.src='https://via.placeholder.com/600x200/0d0d0d/f97316?text=Cover'" alt="Cover">
          <div class="cover-preview-overlay">
            <div class="cover-preview-text" id="coverPreviewText">ชื่อระบบ</div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fa-solid fa-tag"></i> หมวดหมู่</label>
        <select class="form-select" id="fCategory">
          <option value="กลุ่มบริหารงานวิชาการ">กลุ่มบริหารงานวิชาการ</option>
          <option value="กลุ่มบริหารงานงบประมาณ">กลุ่มบริหารงานงบประมาณ</option>
          <option value="กลุ่มบริหารงานทั่วไป">กลุ่มบริหารงานทั่วไป</option>
          <option value="กลุ่มบริหารงานบุคคล">กลุ่มบริหารงานบุคคล</option>
          <option value="อื่นๆ">อื่นๆ</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fa-solid fa-align-left"></i> คำอธิบาย</label>
        <textarea class="form-textarea" id="fDesc" placeholder="อธิบายฟังก์ชันการทำงานของระบบ..." required></textarea>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fa-solid fa-link"></i> ลิงก์เข้าใช้งาน</label>
        <input class="form-input" id="fLink" type="url" placeholder="https://..." required>
      </div>

      <button class="submit-btn" type="submit" id="submitBtn">
        <i class="fa-solid fa-floppy-disk"></i>
        บันทึกข้อมูล
      </button>
    </form>
  </div>
</div>

<!-- ═══════════════════ DETAIL MODAL ═══════════════════ -->
<div class="modal-backdrop" id="detailModal" style="display:none" onclick="closeDetail()">
  <div class="modal-box" onclick="event.stopPropagation()" style="padding:0;overflow:hidden;border-radius:20px;">
    <!-- Cover area: canvas renders bg image + text perfectly -->
    <div style="position:relative;width:100%;height:220px;overflow:hidden;background:#0d0d0d;flex-shrink:0;">
      <canvas id="detailCanvas" style="width:100%;height:100%;display:block;"></canvas>
      <!-- Close button -->
      <button onclick="closeDetail()" style="position:absolute;top:0.85rem;right:0.85rem;background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.18);color:#fff;width:36px;height:36px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;backdrop-filter:blur(6px);z-index:2;">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="detail-body" style="padding:1.5rem">
      <div class="detail-cat" id="detailCat"></div>
      <div class="detail-meta" id="detailMeta"></div>
      <div class="detail-desc" id="detailDesc"></div>
      <!-- Action row: Copy + QR -->
      <div class="detail-action-row">
        <button class="detail-action-btn" onclick="handleCopyFromDetail()">
          <i class="fa-regular fa-copy"></i> คัดลอกลิงก์
        </button>
        <button class="detail-action-btn" onclick="handleQRFromDetail()">
          <i class="fa-solid fa-qrcode"></i> QR Code
        </button>
      </div>
      <a class="detail-link" id="detailLink" href="#" target="_blank">
        <i class="fa-solid fa-arrow-up-right-from-square"></i>
        เข้าใช้งานระบบ
      </a>
    </div>
  </div>
</div>

<!-- ═══════════════════ QR MODAL ═══════════════════ -->
<div class="modal-backdrop" id="qrModal" style="display:none" onclick="closeQR()">
  <div class="qr-modal-box" onclick="event.stopPropagation()">
    <!-- Header -->
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:0.5rem;">
      <div class="qr-title-chip">
        <i class="fa-solid fa-qrcode"></i> QR CODE
      </div>
      <button onclick="closeQR()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:var(--text2);width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;transition:all 0.2s;flex-shrink:0;">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="qr-system-name" id="qrSystemName">ชื่อระบบ</div>
    <div class="qr-url-text" id="qrUrlText">https://...</div>

    <!-- QR Canvas -->
    <div class="qr-canvas-wrap">
      <div class="qr-canvas-frame">
        <canvas id="qrCanvas" width="200" height="200"></canvas>
        <div class="qr-corner qr-corner-tl"></div>
        <div class="qr-corner qr-corner-tr"></div>
        <div class="qr-corner qr-corner-bl"></div>
        <div class="qr-corner qr-corner-br"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="qr-actions">
      <button class="qr-btn qr-btn-primary" onclick="downloadQR()">
        <i class="fa-solid fa-download"></i> บันทึก QR
      </button>
      <button class="qr-btn qr-btn-ghost" id="qrCopyBtn" onclick="copyFromQRModal()">
        <i class="fa-regular fa-copy"></i> คัดลอกลิงก์
      </button>
    </div>

    <!-- Template text box -->
    <div style="margin-top:1rem;background:rgba(249,115,22,0.06);border:1px solid var(--border);border-radius:12px;padding:1rem;position:relative;">
      <div style="font-size:0.7rem;color:var(--orange);font-weight:700;letter-spacing:0.06em;text-transform:uppercase;margin-bottom:0.6rem;display:flex;align-items:center;gap:0.4rem;">
        <i class="fa-solid fa-message"></i> เทมเพลตข้อความ
      </div>
      <div id="qrTemplateText" style="font-size:0.82rem;color:var(--text2);line-height:1.7;white-space:pre-wrap;word-break:break-word;"></div>
      <button onclick="copyTemplate()" style="margin-top:0.75rem;width:100%;padding:0.6rem;border-radius:10px;background:rgba(249,115,22,0.15);border:1px solid var(--border);color:var(--orange);font-family:'Kanit',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.4rem;transition:all 0.3s;">
        <i class="fa-regular fa-clipboard"></i> คัดลอกเทมเพลต
      </button>
    </div>
  </div>
</div>

<!-- Copy Toast -->
<div class="copy-toast" id="copyToast" style="display:none;">
  <i class="fa-solid fa-check"></i>
  <span id="copyToastMsg">คัดลอกแล้ว!</span>
</div>

<script>
// ─── Config ───────────────────────────────────────────────
const GAS_URL = "https://script.google.com/macros/s/AKfycbwpwGoqsV9At_orPyPH3_59kNPb5qempWEp7-bjrsNDZXUjhuEjyc-GoqjRoZWxLlkJ/exec";
const COVER_IMG = "https://nonthaphathr.github.io/uploadimg/cardcover.png";
const ADMIN_PIN = "1234";

const CAT_STYLES = {
  "กลุ่มบริหารงานวิชาการ":  "cat-academic",
  "กลุ่มบริหารงานงบประมาณ": "cat-finance",
  "กลุ่มบริหารงานทั่วไป":   "cat-admin",
  "กลุ่มบริหารงานบุคคล":    "cat-student",
  "อื่นๆ":                  "cat-other"
};

// ─── State ────────────────────────────────────────────────
let allData = [];
let currentCat = "ทั้งหมด";
let searchQ = "";
let isEditMode = false;
let qrCurrentData = null;   // { title, link } for active QR modal
let detailCurrentId = null; // id of currently open detail

// ─── SweetAlert helpers ───────────────────────────────────
const Toast = Swal.mixin({
  toast:true, position:'bottom', showConfirmButton:false,
  timer:3000, timerProgressBar:true,
  customClass:{popup:'rounded-2xl shadow-2xl'},
  didOpen:(t)=>{t.onmouseenter=Swal.stopTimer;t.onmouseleave=Swal.resumeTimer}
});
const showSuccess = m => Toast.fire({icon:'success', title:m, background:'#1a1a1a', color:'#f5f5f5'});
const showError   = m => Swal.fire({icon:'error', title:'เกิดข้อผิดพลาด', text:m, background:'#1a1a1a', color:'#f5f5f5', confirmButtonColor:'#f97316'});
const showLoading = (m='กำลังดำเนินการ...') => Swal.fire({title:m, allowOutsideClick:false, background:'#1a1a1a', color:'#f5f5f5', didOpen:()=>Swal.showLoading()});
const closeLoading = () => Swal.close();

const checkAdmin = async () => {
  const r = await Swal.fire({
    title:'ยืนยันตัวตน', input:'password',
    inputPlaceholder:'รหัส Admin', showCancelButton:true,
    confirmButtonColor:'#f97316', cancelButtonColor:'#374151',
    confirmButtonText:'ยืนยัน', cancelButtonText:'ยกเลิก',
    background:'#1a1a1a', color:'#f5f5f5',
    inputAttributes:{autocapitalize:'off'}
  });
  return r.value === ADMIN_PIN;
};

const confirmDel = async name => {
  const r = await Swal.fire({
    title:'ยืนยันการลบ', text:`ลบ "${name}" ใช่หรือไม่?`, icon:'warning',
    showCancelButton:true, confirmButtonColor:'#ef4444', cancelButtonColor:'#374151',
    confirmButtonText:'ลบ', cancelButtonText:'ยกเลิก',
    background:'#1a1a1a', color:'#f5f5f5'
  });
  return r.isConfirmed;
};

// ─── Fetch ────────────────────────────────────────────────
async function fetchData() {
  renderSkeleton();
  try {
    const r = await fetch(GAS_URL);
    const d = await r.json();
    allData = Array.isArray(d) ? d.reverse() : [];
  } catch(e) {
    console.warn("Fetch error:", e);
    allData = [];
  }
  updateStats();
  renderCards();
}

// ─── Stats ────────────────────────────────────────────────
function updateStats() {
  animateCount(document.getElementById('statCount'), allData.length);
  const cats = new Set(allData.map(d=>d.category)).size;
  animateCount(document.getElementById('statCat'), cats);
}

function animateCount(el, end, dur=1000) {
  if(!el) return;
  let start=0, step=end/50;
  const t=setInterval(()=>{
    start = Math.min(start+step, end);
    el.textContent = Math.floor(start);
    if(start>=end) clearInterval(t);
  }, dur/50);
}

// ─── Filter ───────────────────────────────────────────────
document.getElementById('filterBar').addEventListener('click', e=>{
  const chip = e.target.closest('.filter-chip');
  if(!chip) return;
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  currentCat = chip.dataset.cat;
  renderCards();
});

document.getElementById('searchInput').addEventListener('input', e=>{
  searchQ = e.target.value.toLowerCase().trim();
  renderCards();
});

// ─── Render ───────────────────────────────────────────────
function getFiltered() {
  return allData.filter(d=>{
    const matchCat = currentCat==="ทั้งหมด" || d.category===currentCat;
    const matchQ = !searchQ ||
      d.title?.toLowerCase().includes(searchQ) ||
      d.coverTitle?.toLowerCase().includes(searchQ) ||
      d.description?.toLowerCase().includes(searchQ) ||
      d.category?.toLowerCase().includes(searchQ);
    return matchCat && matchQ;
  });
}

function renderSkeleton() {
  const g = document.getElementById('cardGrid');
  g.innerHTML = Array(6).fill(0).map(()=>`
    <div class="skeleton-card">
      <div class="skel skel-cover"></div>
      <div class="skel-body">
        <div class="skel skel-line skel-sm" style="margin-bottom:12px"></div>
        <div class="skel skel-line skel-md"></div>
        <div class="skel skel-line skel-lg"></div>
        <div class="skel skel-line skel-sm" style="margin-top:16px"></div>
      </div>
    </div>`).join('');
  document.getElementById('resultCount').textContent = 'กำลังโหลด...';
}

function renderCards() {
  const data = getFiltered();
  const g = document.getElementById('cardGrid');
  document.getElementById('resultCount').textContent = `แสดง ${data.length} ระบบ`;

  if(!data.length) {
    g.innerHTML = `
      <div class="empty">
        <div class="empty-icon"><i class="fa-solid fa-ghost"></i></div>
        <h3>ไม่พบข้อมูล</h3>
        <p>ลองค้นหาด้วยคำอื่น หรือเปลี่ยนหมวดหมู่</p>
      </div>`;
    return;
  }

  g.innerHTML = data.map((d, i) => {
    const catClass = CAT_STYLES[d.category] || 'cat-other';
    const title = d.coverTitle || d.title || '-';
    const date = d.timestamp ? new Date(d.timestamp).toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}) : '';
    return `
    <div class="card" style="animation-delay:${i*0.06}s" onclick="openDetail('${d.id}')">
      <div class="card-cover">
        <img class="card-cover-bg" src="${COVER_IMG}" alt="cover"
          onerror="this.src='https://via.placeholder.com/600x200/111/f97316?text=Cover'">
        <div class="card-cover-overlay">
          <div class="card-cover-title">${escHtml(title)}</div>
        </div>
      </div>
      <div class="card-body">
        <div class="card-meta">
          <span class="card-cat ${catClass}">${escHtml(d.category||'อื่นๆ')}</span>
          ${date ? `<span class="card-date"><i class="fa-regular fa-clock"></i>${date}</span>` : ''}
        </div>
        <h3 class="card-name">${escHtml(d.title||'-')}</h3>
        <p class="card-desc">${escHtml(d.description||'-')}</p>
        <div class="card-footer">
          <a class="card-link" href="${escHtml(d.link||'#')}" target="_blank" onclick="event.stopPropagation()">
            <i class="fa-solid fa-arrow-up-right-from-square"></i> เข้าใช้งาน
          </a>
          <div class="card-actions">
            <button class="icon-btn" title="คัดลอกลิงก์" onclick="event.stopPropagation();handleCopy('${d.id}')">
              <i class="fa-regular fa-copy"></i>
            </button>
            <button class="icon-btn" title="QR Code" onclick="event.stopPropagation();handleQR('${d.id}')">
              <i class="fa-solid fa-qrcode"></i>
            </button>
            <button class="icon-btn" title="แก้ไข" onclick="event.stopPropagation();handleEdit('${d.id}')">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="icon-btn delete" title="ลบ" onclick="event.stopPropagation();handleDelete('${d.id}','${escHtml(d.title||'')}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ─── Detail Modal ─────────────────────────────────────────
function openDetail(id) {
  const d = allData.find(x=>x.id===id);
  if(!d) return;
  const catClass = CAT_STYLES[d.category] || 'cat-other';
  const date = d.timestamp ? new Date(d.timestamp).toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'}) : '';

  detailCurrentId = id;
  document.getElementById('detailCat').innerHTML = `<i class="fa-solid fa-tag"></i> ${escHtml(d.category||'อื่นๆ')}`;
  document.getElementById('detailMeta').innerHTML = date ? `<i class="fa-regular fa-calendar"></i> ${date}` : '';
  document.getElementById('detailDesc').textContent = d.description || '-';
  document.getElementById('detailLink').href = d.link || '#';

  // Show modal first so canvas has real dimensions
  document.getElementById('detailModal').style.display='flex';
  document.body.style.overflow='hidden';
  // Draw cover canvas after layout paint
  requestAnimationFrame(() => requestAnimationFrame(() => drawCoverCanvas(d.coverTitle || d.title || '-')));
}

// Draw background image + centered text on canvas
function drawCoverCanvas(titleText) {
  const canvas = document.getElementById('detailCanvas');
  if(!canvas) return;

  // Match displayed size
  const W = canvas.offsetWidth || 480;
  const H = 220;
  canvas.width  = W * (window.devicePixelRatio || 1);
  canvas.height = H * (window.devicePixelRatio || 1);
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

  const renderText = () => {
    // Gradient overlay: top-to-bottom dark
    const grad = ctx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, 'rgba(0,0,0,0.25)');
    grad.addColorStop(0.5, 'rgba(0,0,0,0.45)');
    grad.addColorStop(1, 'rgba(0,0,0,0.82)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    // Wrap text
    const fontSize = W < 380 ? 18 : 22;
    ctx.font = `700 ${fontSize}px Kanit, sans-serif`;
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0,0,0,0.9)';
    ctx.shadowBlur = 12;
    ctx.shadowOffsetY = 2;

    const maxWidth = W - 64;
    const words = titleText.split('');
    // For Thai text, wrap by pixel width
    const lines = [];
    let line = '';
    for(let i = 0; i < titleText.length; i++) {
      const testLine = line + titleText[i];
      if(ctx.measureText(testLine).width > maxWidth && line !== '') {
        lines.push(line);
        line = titleText[i];
      } else {
        line = testLine;
      }
    }
    if(line) lines.push(line);

    const lineH = fontSize * 1.45;
    const totalH = lines.length * lineH;
    const startY = H/2 - totalH/2 + lineH/2 + 10;
    lines.forEach((l, i) => {
      ctx.fillText(l, W/2, startY + i * lineH);
    });

    ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
  };

  // Try to draw background image
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    ctx.drawImage(img, 0, 0, W, H);
    renderText();
  };
  img.onerror = () => {
    // Fallback: dark gradient background
    const bgGrad = ctx.createLinearGradient(0,0,W,H);
    bgGrad.addColorStop(0,'#1a1a1a');
    bgGrad.addColorStop(1,'#0d0d0d');
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0,0,W,H);
    renderText();
  };
  img.src = COVER_IMG;
}

// ─── Copy Toast ───────────────────────────────────────────
let copyToastTimer = null;
function showCopyToast(msg='คัดลอกแล้ว!') {
  const el = document.getElementById('copyToast');
  document.getElementById('copyToastMsg').textContent = msg;
  el.style.display='flex';
  el.style.animation='none';
  requestAnimationFrame(()=>{ el.style.animation='copyPop 0.4s ease'; });
  clearTimeout(copyToastTimer);
  copyToastTimer = setTimeout(()=>{ el.style.display='none'; }, 2500);
}

// ─── Copy Link ────────────────────────────────────────────
function handleCopy(id) {
  const d = allData.find(x=>x.id===id);
  if(!d) return;
  const text = buildCopyTemplate(d.title, d.link);
  navigator.clipboard.writeText(text).then(()=>{
    showCopyToast('คัดลอกข้อความแล้ว!');
  }).catch(()=>{ showCopyToast('คัดลอกแล้ว!'); });
}

function handleCopyFromDetail() {
  const d = allData.find(x=>x.id===detailCurrentId);
  if(!d) return;
  const text = buildCopyTemplate(d.title, d.link);
  navigator.clipboard.writeText(text).then(()=>{ showCopyToast('คัดลอกข้อความแล้ว!'); });
}

function buildCopyTemplate(title, link) {
  return `📌 ${title}\n🔗 ${link}\n\n— ระบบรวบรวมระบบจัดการงานโรงเรียนแบบออนไลน์`;
}

// ─── QR Code ─────────────────────────────────────────────
let qrInstance = null;

function handleQR(id) {
  const d = allData.find(x=>x.id===id);
  if(!d) return;
  openQRModal(d);
}

function handleQRFromDetail() {
  const d = allData.find(x=>x.id===detailCurrentId);
  if(!d) return;
  openQRModal(d);
}

function openQRModal(d) {
  qrCurrentData = { title: d.title || '-', link: d.link || '' };

  document.getElementById('qrSystemName').textContent = d.title || '-';
  document.getElementById('qrUrlText').textContent = d.link || '-';
  document.getElementById('qrTemplateText').textContent = buildCopyTemplate(d.title, d.link);

  // Clear & draw QR
  const container = document.getElementById('qrCanvas');
  container.getContext('2d').clearRect(0, 0, 200, 200);

  // Use API-based QR render onto canvas
  drawQRtoCanvas(d.link || 'https://example.com');

  document.getElementById('qrModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function drawQRtoCanvas(url) {
  const canvas = document.getElementById('qrCanvas');
  const ctx = canvas.getContext('2d');
  const size = 200;
  canvas.width = size;
  canvas.height = size;

  // Use qrcode.js to generate QR into a temp div then extract image
  const tmpDiv = document.createElement('div');
  tmpDiv.style.display = 'none';
  document.body.appendChild(tmpDiv);

  try {
    new QRCode(tmpDiv, {
      text: url,
      width: size,
      height: size,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });

    // QRCode.js creates either canvas or img
    setTimeout(() => {
      const qrCanvas = tmpDiv.querySelector('canvas');
      const qrImg = tmpDiv.querySelector('img');

      if (qrCanvas) {
        // Draw onto our canvas
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);
        ctx.drawImage(qrCanvas, 0, 0, size, size);
      } else if (qrImg) {
        const img = new Image();
        img.onload = () => {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, size, size);
          ctx.drawImage(img, 0, 0, size, size);
        };
        img.src = qrImg.src;
      }
      document.body.removeChild(tmpDiv);
    }, 80);
  } catch(e) {
    document.body.removeChild(tmpDiv);
    // Fallback: use QR API image
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);
      ctx.drawImage(img, 0, 0, size, size);
    };
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(url)}&format=png`;
  }
}

function closeQR() {
  document.getElementById('qrModal').style.display = 'none';
  document.body.style.overflow = '';
  qrCurrentData = null;
}

function downloadQR() {
  const canvas = document.getElementById('qrCanvas');
  const name = (qrCurrentData?.title || 'qr').replace(/[^a-zA-Zก-๙0-9]/g,'_').slice(0,40);

  // Create larger download canvas with branding
  const dlCanvas = document.createElement('canvas');
  const pad = 32;
  const qrSize = 240;
  const footerH = 72;
  dlCanvas.width  = qrSize + pad * 2;
  dlCanvas.height = qrSize + pad * 2 + footerH;
  const ctx = dlCanvas.getContext('2d');

  // Background
  ctx.fillStyle = '#111111';
  ctx.fillRect(0, 0, dlCanvas.width, dlCanvas.height);

  // Orange border glow
  ctx.strokeStyle = 'rgba(249,115,22,0.6)';
  ctx.lineWidth = 2;
  ctx.strokeRect(1, 1, dlCanvas.width-2, dlCanvas.height-2);

  // White QR area
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.roundRect(pad-8, pad-8, qrSize+16, qrSize+16, 12);
  ctx.fill();

  // Draw QR
  ctx.drawImage(canvas, pad, pad, qrSize, qrSize);

  // Footer text
  ctx.fillStyle = '#f97316';
  ctx.font = 'bold 13px Kanit, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('📌 ' + (qrCurrentData?.title || ''), dlCanvas.width/2, qrSize + pad*2 + 20);
  ctx.fillStyle = '#a3a3a3';
  ctx.font = '11px Kanit, sans-serif';
  ctx.fillText('สแกนเพื่อเข้าใช้งานระบบ', dlCanvas.width/2, qrSize + pad*2 + 40);

  const a = document.createElement('a');
  a.download = `QR_${name}.png`;
  a.href = dlCanvas.toDataURL('image/png');
  a.click();
  showCopyToast('บันทึก QR Code แล้ว!');
}

function copyFromQRModal() {
  if(!qrCurrentData) return;
  navigator.clipboard.writeText(qrCurrentData.link).then(()=>{
    showCopyToast('คัดลอกลิงก์แล้ว!');
  });
}

function copyTemplate() {
  if(!qrCurrentData) return;
  const text = buildCopyTemplate(qrCurrentData.title, qrCurrentData.link);
  navigator.clipboard.writeText(text).then(()=>{
    showCopyToast('คัดลอกเทมเพลตแล้ว!');
  });
}

function closeDetail() {
  document.getElementById('detailModal').style.display='none';
  document.body.style.overflow='';
  detailCurrentId = null;
}

// ─── Form Modal ───────────────────────────────────────────
document.getElementById('openAddBtn').onclick = () => openForm();

function openForm(data=null) {
  isEditMode = !!data;
  document.getElementById('editId').value = data?.id || '';
  document.getElementById('fTitle').value = data?.title || '';
  document.getElementById('fCoverTitle').value = data?.coverTitle || '';
  document.getElementById('fCategory').value = data?.category || 'กลุ่มบริหารงานวิชาการ';
  document.getElementById('fDesc').value = data?.description || '';
  document.getElementById('fLink').value = data?.link || '';
  document.getElementById('modalTitle').textContent = isEditMode ? 'แก้ไขข้อมูลระบบ' : 'เพิ่มระบบใหม่';
  updateCoverPreview();
  document.getElementById('formModal').style.display='flex';
  document.body.style.overflow='hidden';
  setTimeout(()=>document.getElementById('fTitle').focus(), 100);
}

function closeModal() {
  document.getElementById('formModal').style.display='none';
  document.body.style.overflow='';
  document.getElementById('systemForm').reset();
}

document.getElementById('formModal').onclick = e => {
  if(e.target===document.getElementById('formModal')) closeModal();
};

// Cover preview
function updateCoverPreview() {
  const ct = document.getElementById('fCoverTitle').value ||
             document.getElementById('fTitle').value ||
             'ชื่อระบบ';
  document.getElementById('coverPreviewText').textContent = ct;
}

document.getElementById('fTitle').addEventListener('input', ()=>{
  if(!document.getElementById('fCoverTitle').value)
    updateCoverPreview();
});
document.getElementById('fCoverTitle').addEventListener('input', updateCoverPreview);

// ─── Submit ───────────────────────────────────────────────
async function handleSubmit(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  showLoading('กำลังบันทึกข้อมูล...');

  const title = document.getElementById('fTitle').value.trim();
  const coverTitle = document.getElementById('fCoverTitle').value.trim() || title;
  const payload = {
    action: isEditMode ? 'update' : 'create',
    id: document.getElementById('editId').value || null,
    title, coverTitle,
    category: document.getElementById('fCategory').value,
    description: document.getElementById('fDesc').value.trim(),
    link: document.getElementById('fLink').value.trim()
  };

  try {
    await fetch(GAS_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    closeLoading();
    showSuccess(isEditMode ? 'แก้ไขข้อมูลสำเร็จ!' : 'เพิ่มระบบสำเร็จ!');
    closeModal();
    setTimeout(fetchData, 1500);
  } catch(err) {
    closeLoading();
    showError(err.message);
  } finally {
    btn.disabled = false;
  }
}

// ─── Edit ─────────────────────────────────────────────────
async function handleEdit(id) {
  if(!await checkAdmin()) { showError('รหัสผ่านไม่ถูกต้อง'); return; }
  const d = allData.find(x=>x.id===id);
  if(d) openForm(d);
}

// ─── Delete ───────────────────────────────────────────────
async function handleDelete(id, name) {
  if(!await checkAdmin()) { showError('รหัสผ่านไม่ถูกต้อง'); return; }
  if(!await confirmDel(name)) return;
  showLoading('กำลังลบข้อมูล...');
  try {
    await fetch(GAS_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({action:'delete', id})
    });
    closeLoading();
    showSuccess('ลบข้อมูลสำเร็จ!');
    setTimeout(fetchData, 1000);
  } catch(err) {
    closeLoading();
    showError(err.message);
  }
}

// ─── Util ─────────────────────────────────────────────────
function escHtml(str) {
  return String(str||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Init ─────────────────────────────────────────────────
window.addEventListener('load', ()=>{
  setTimeout(()=>{
    document.getElementById('loader').style.display='none';
  }, 1600);
  fetchData();
});

// Keyboard shortcut
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') { closeModal(); closeDetail(); closeQR(); }
});
</script>
</body>
</html>
